<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:c="http://java.sun.com/jsp/jstl/core"
                xmlns:t="http://java.sun.com/jsf/composite/telveComponents"
                xmlns:fn="http://java.sun.com/jsp/jstl/functions"
                template="/layout/raf/editorTemplate.xhtml">

    <ui:param name="dontShowContentHeader" value="true" />
    <ui:param name="showContextMenu" value="false" />
    <ui:param name="pageTitle" value="Online Editor" />

    <ui:define name="body">

        <style type="text/css">
            body {
                margin: 0;
                padding: 0;
                overflow: hidden;
                -ms-content-zooming: none;
            }

            #office_frame {
                width: 100%;
                height: 100%;
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                margin: 0;
                border: none;
                display: block;
            }

            #frameholder {
                position: absolute;
                top: 50px;
                bottom: 0px;
                left: 0;
                right: 0;
                padding: px;
                padding-left: 2px;
            }
        </style>

        <form id="office_form" name="office_form" target="office_frame" action="#{onlineEditorController.wopiUrl}" method="post">
            <input name="access_token" value="#{onlineEditorController.token}" type="hidden" />
            <input name="access_token_ttl" value="0" type="hidden" />
            <input name="ui_defaults" value="UIMode=notebookbar;TextRuler=false;PresentationStatusbar=false;SpreadsheetSidebar=false" type="hidden"/>'
        </form>

        <span id="frameholder"></span>

        <script type="text/javascript">
            var frameholder = document.getElementById('frameholder');
            var office_frame = document.createElement('iframe');
            office_frame.name = 'office_frame';
            office_frame.id = 'office_frame';

            office_frame.title = 'Office Frame';
            office_frame.setAttribute('allowfullscreen', 'true');

            //office_frame.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-popups allow-top-navigation allow-popups-to-escape-sandbox');
            frameholder.appendChild(office_frame);

            document.getElementById('office_form').submit();
            
            //TODO: Console Logları kapatılacak
            function postMessageHandler(event) {
                console.log("We've got a message!");
                console.log("* Message:", event.data);
                console.log("* Origin:", event.origin);
                console.log("* Source:", event.source);

                // check request is from legitimate source and message is expected or not
                /*
                 if (event.origin !== 'http://blah.example.com') {
                 return;
                 }
                 if (event.data === 'Hello') {
                 // give response
                 event.source.postMessage('world!', 'http://blah.example.com');
                 }*/
                var msg = JSON.parse(event.data);
                if (!msg) {
                    return;
                }

                if (msg.MessageId === 'App_LoadingStatus') {
                    if (msg.Values) {
                        if (msg.Values.Status === 'Document_Loaded') {
                            console.log('==== inform the wopi client that we are ready to receife messages');
                            window.frames[0].postMessage(JSON.stringify({'MessageId': 'Host_PostmessageReady'}), '*');
                        }
                    }
                }
            }

            // helper method to post a message
            function post(msg) {
                console.log("==== sending new message : " + JSON.stringify(msg));
                window.getElemetById('office_frame').postMessage(JSON.stringify(msg), '*');
            }

            if (window.addEventListener) {
                window.addEventListener("message", postMessageHandler, false);
            } else {
                window.attachEvent("onmessage", postMessageHandler);
            }
        </script>


    </ui:define>

</ui:composition>
